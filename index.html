<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8">
        <title>배꼽시계</title>
        <link rel="stylesheet" href="assets/css/normalize.css" />
        <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />

        <style>
            header{
                box-sizing: border-box; padding: 10px; display: flex; align-items: center; justify-content: space-between;
                background: gold; margin-bottom: 10px;
            }
            .btn-start{outline: 0; width: 80px; background: silver; border: 0; padding: 5px 0; border-radius: 5px;}
            h1{margin: 0; padding: 0;}

            .content-wrapper{width: 280px; margin: 0 auto; padding: 0 10px; box-sizing: border-box;}

            .radios input{display: none;}
            .radios input + span{
                display: inline-flex; width: 32px; height: 32px; align-items: center; justify-content: center; border-radius: 50%; font-size: 10px;
                opacity: .3;
            }

            .radios input:checked + span{opacity: 1; box-shadow: inset 0 0 5px #fff;}

            .radios label:nth-child(1) span{background: red;}
            .radios label:nth-child(2) span{background: orange;}
            .radios label:nth-child(3) span{background: yellow;}
            .radios label:nth-child(4) span{background: green; color: #fff;}
            .radios label:nth-child(5) span{background: blue; color: #fff;}
            .radios label:nth-child(6) span{background: navy; color: #fff;}
            .radios label:nth-child(7) span{background: purple; color: #fff;}

            .txt-timer.off, .handle.off{opacity: 0; transition: opacity .5s;}
            .txt-timer{text-align: center; font-size: 20px; margin-bottom: 10px;}
            .integer{}
            .decimal{font-size: 13px;}
            .diff-sec{height: 20px; display: flex; align-items: center; justify-content: center; margin-bottom: 10px;}
            .img-timer{
                border-radius: 50%; width: 120px; height: 120px; border: 5px solid gold; box-sizing: border-box; position: relative;
                background: linear-gradient(135deg, #000, navy); margin: 0 auto; margin-bottom: 10px;
            }
            .handle{position: absolute; top: 0; left: 0; right: 0; bottom: 0; box-sizing: border-box;}
            .handle:after{
                content: ''; position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
                width: 2px; height: 50px; border-radius: 50% 50% 0 0; background: linear-gradient(transparent, red);
            }

            .stop-btn-wrapper{text-align: center;}
            .btn-stop{background: #d00; color: #fff; padding: 30px; border: 0; outline: 0; font-size: 50px; border-radius: 8px;}
        </style>
        
     </head>
     <body>
        <header>
            <h1>t!mer</h1>
            <button class="btn-start" onclick="timer.startGame();">시작</button>
        </header>
        <div class="content-wrapper">
            <div id="radios" class="radios">
                <label><input type="radio" name="sec" value="5"><span>5초</span></label>
                <label><input type="radio" name="sec" value="6"><span>6초</span></label>
                <label><input type="radio" name="sec" value="7"><span>7초</span></label>
                <label><input type="radio" name="sec" value="8"><span>8초</span></label>
                <label><input type="radio" name="sec" value="9"><span>9초</span></label>
                <label><input type="radio" name="sec" value="10"><span>10초</span></label>
                <label><input type="radio" name="sec" value="0" checked><span>랜덤</span></label>
            </div>
            <h2 id="guide" class="guide">시작버튼 클릭!</h2>
            <div id="diffSec" class="diff-sec"></div>
            <div id="txtTimer" class="txt-timer">0초</div>
            <div id="imgTimer" class="img-timer">
                <div id="handle" class="handle"></div>
            </div>
            <div class="stop-btn-wrapper">
                <button class="btn-stop" onclick="timer.stop();">STOP</button>
            </div>
        </div>

        <script>
            function getRandomNum(mn, mx){return Math.floor(Math.random() * (mx - mn + 1)) + mn;};

            const guide = document.querySelector('#guide');
            const txtTimer = document.querySelector('#txtTimer');
            const imgTimer = document.querySelector('#imgTimer');
            const handle = document.querySelector('#handle');
            const diffSec = document.querySelector('#diffSec');
            
            const timer = new Timer();

            function Timer () {
                const t = this;

                t.oldTimeStamp = 0;

                t.init = function () {
                    t.questSec = 0;
                    window.cancelAnimationFrame(t.raf);
                    t.raf;
                    t.startTime = 0;
                    t.nowTime = 0;
                    t.isOver2 = false;
                    t.isStop = false;
                    txtTimer.innerHTML = '<div>0초</div>';
                    handle.style.transform = 'rotate(0)';
                    txtTimer.classList.remove('off');
                    handle.classList.remove('off');
                    diffSec.innerHTML = '';

                }
                t.init();

                t.startGame = function(){
                    t.init();

                    const secVal = document.querySelector('#radios input:checked').value;

                    t.questSec = +secVal || getRandomNum(5, 10);
                    t.startTime = window.performance.now();
                    guide.innerHTML = '<span>' + t.questSec + '초를 맞추세요.<span>';
                    t.raf = window.requestAnimationFrame(t.ing);
                }

                t.stop = function(){
                    if(!t.startTime) return;
                    // t.nowTime = window.performance.now();
                    // const sec = (t.nowTime - t.startTime) / 1000;
                    // txtTimer.innerHTML = '<div>' + sec + '초</div>';
                    // handle.style.transform = 'rotate(' + (sec / t.questSec * 360) + 'deg)';
                    t.gameOver();
                };
                
                t.ing = function(timeStamp){
                    if(t.isStop) return window.cancelAnimationFrame(t.raf);


                    if(t.oldTimeStamp > timeStamp){
                        alert('시간을 바꾸셨네요..?');
                        window.location.reload();
                    };

                    t.oldTimeStamp = timeStamp;

                    const sec = (timeStamp - t.startTime) / 1000;

                    if(sec < 0){
                        t.raf = window.requestAnimationFrame(t.ing);
                        return;
                    }

                    const secArr = ('' + sec).split('.');

                    const secTemplate = '<div><span class="integer">' + secArr[0].padStart(2, 0) + '</span>.<span class="decimal">' + secArr[1].padEnd(16, 0); +'</span>초</div>';

                    txtTimer.innerHTML = secTemplate;
                    handle.style.transform = 'rotate(' + (sec / t.questSec * 360)+ 'deg)';

                    if(!t.isOver2 && sec > 3){
                        txtTimer.classList.add('off');
                        handle.classList.add('off');
                        t.isOver2 = true;
                    }else if(sec > t.questSec + 5){
                        t.gameOver('over');
                    }
                    
                    t.raf = window.requestAnimationFrame(t.ing);
                }

                t.gameOver = function(result){
                    t.isStop = true;
                    t.raf = window.cancelAnimationFrame(t.raf);
                    txtTimer.classList.remove('off');
                    handle.classList.remove('off');
                    if(result == 'over'){
                        guide.innerHTML = '<span>시간이 너무 지남...</span>';
                    }else{
                        setTimeout(function(){
                            const stopTime = +txtTimer.innerText;
                            diffSec.innerHTML = '오차: ' + Math.abs((t.questSec - stopTime));
                        }, 300);
                        guide.innerTHML = '시작버튼 클릭!';
                    }
                }
            }
        </script>
     </body>
</html>